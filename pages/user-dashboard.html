<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>User Dashboard - Secure Walkways</title>
  <style>
    :root {
      --bg-gradient-dark: radial-gradient(circle at top, #1f1f2e, #12121b 55%);
      --bg-gradient-light: radial-gradient(circle at top, #f7f9fc, #dce3f2 60%);
      --card-bg-dark: rgba(22, 24, 38, 0.9);
      --card-bg-light: rgba(255, 255, 255, 0.85);
      --border-dark: rgba(90, 110, 255, 0.2);
      --border-light: rgba(41, 76, 155, 0.12);
      --text-primary-dark: #f5f7ff;
      --text-primary-light: #1b2540;
      --text-muted-dark: #8b92b7;
      --text-muted-light: #5b6785;
      --accent-blue: #4f8bff;
      --accent-green: #45d483;
      --accent-amber: #ffb347;
      --accent-red: #ff5f6d;
      --shadow-dark: 0 24px 50px rgba(4, 10, 34, 0.45);
      --shadow-light: 0 24px 40px rgba(31, 51, 109, 0.18);
      --radius-lg: 24px;
      --radius-md: 16px;
      --radius-sm: 12px;
      --transition-fast: 0.25s ease;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg-gradient-dark);
      color: var(--text-primary-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 48px 24px;
      transition: background 0.6s ease, color var(--transition-fast);
    }

    .container {
      width: min(980px, 100%);
      background: var(--card-bg-dark);
      border-radius: var(--radius-lg);
      padding: 40px clamp(24px, 4vw, 48px);
      box-shadow: var(--shadow-dark);
      backdrop-filter: blur(18px);
      border: 1px solid var(--border-dark);
      transition: background var(--transition-fast), border-color var(--transition-fast), box-shadow var(--transition-fast);
    }

    h2 {
      font-size: clamp(28px, 4vw, 34px);
      margin: 0;
      letter-spacing: -0.02em;
    }

    .dashboard-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 16px;
      justify-content: space-between;
      margin-bottom: 32px;
    }

    .welcome-subtitle {
      margin: 8px 0 0;
      color: var(--text-muted-dark);
      font-size: 16px;
    }

    .status-pill {
      padding: 8px 16px;
      border-radius: 999px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid transparent;
      transition: transform var(--transition-fast), background var(--transition-fast), color var(--transition-fast), border-color var(--transition-fast);
    }

    .status-pill.active {
      background: rgba(79, 139, 255, 0.16);
      color: #9ec4ff;
      border-color: rgba(79, 139, 255, 0.3);
    }

    .status-pill.inactive {
      background: rgba(139, 146, 183, 0.1);
      color: var(--text-muted-dark);
      border-color: rgba(139, 146, 183, 0.18);
    }

    .section {
      margin-bottom: 32px;
      padding: 28px;
      border-radius: var(--radius-md);
      background: rgba(11, 13, 26, 0.55);
      border: 1px solid rgba(94, 108, 197, 0.18);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), border-color var(--transition-fast);
    }

    .section:hover {
      transform: translateY(-3px);
      box-shadow: 0 16px 38px rgba(4, 15, 34, 0.4);
    }

    .section-title {
      font-size: 18px;
      margin: 0 0 20px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--text-muted-dark);
    }

    .overview-grid {
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      margin-bottom: 24px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.04);
      border-radius: var(--radius-sm);
      padding: 16px 18px;
      border: 1px solid rgba(98, 124, 240, 0.14);
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 96px;
      transition: transform var(--transition-fast), border-color var(--transition-fast);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      border-color: rgba(98, 124, 240, 0.32);
    }

    .stat-label {
      font-size: 13px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted-dark);
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary-dark);
    }

    .stat-value.accent-green {
      color: var(--accent-green);
    }

    .stat-value.accent-amber {
      color: var(--accent-amber);
    }

    .progress-container {
      position: relative;
      height: 16px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      overflow: hidden;
    }

    #progressBar {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 12px;
      font-size: 12px;
      font-weight: 600;
      color: #fff;
      min-width: 48px;
      background: linear-gradient(90deg, #4f8bff, #8c6ef9);
      transition: width 0.4s ease;
    }

    #activeWalkInfo {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    #activeWalkInfo p {
      margin: 0;
      color: var(--text-muted-dark);
      font-size: 15px;
    }

    #activeWalkInfo strong {
      color: var(--text-primary-dark);
    }

    #checkpointsList {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .checkpoint-item {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      border-radius: var(--radius-sm);
      background: rgba(21, 28, 53, 0.6);
      border: 1px solid rgba(93, 110, 212, 0.16);
      transition: border-color var(--transition-fast), transform var(--transition-fast);
    }

    .checkpoint-item:hover {
      border-color: rgba(93, 110, 212, 0.38);
      transform: translateX(6px);
    }

    .checkpoint-item .name {
      font-weight: 600;
      font-size: 15px;
    }

    .checkpoint-item span[class^="status-"] {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      padding: 8px 14px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .status-completed {
      background: rgba(69, 212, 131, 0.14);
      color: #8be6b6;
    }

    .status-missed {
      background: rgba(255, 95, 109, 0.16);
      color: #ffb1b9;
    }

    .status-pending,
    .status-in_progress {
      background: rgba(255, 179, 71, 0.16);
      color: #ffd29a;
    }

    .timestamp {
      color: rgba(255, 255, 255, 0.6);
      font-size: 12px;
      font-weight: 500;
    }

    #noActiveWalkMessage {
      display: none;
      align-items: center;
      justify-content: center;
      text-align: center;
      background: rgba(15, 19, 31, 0.6);
      border: 1px dashed rgba(98, 124, 240, 0.32);
      color: var(--text-muted-dark);
    }

    #noActiveWalkMessage p {
      margin: 0 0 12px;
      font-size: 16px;
    }

    .cta-hint {
      font-size: 14px;
      color: var(--text-muted-dark);
    }

    .button-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-top: 12px;
    }

    .action-btn {
      border: none;
      border-radius: var(--radius-sm);
      padding: 16px 18px;
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      background: linear-gradient(120deg, #3f72ff, #7f53ff);
      color: #fff;
      cursor: pointer;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), filter var(--transition-fast);
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 26px rgba(63, 114, 255, 0.35);
    }

    .action-btn.secondary {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-primary-dark);
      border: 1px solid rgba(145, 166, 255, 0.28);
    }

    .action-btn.secondary:hover {
      box-shadow: 0 12px 20px rgba(11, 13, 26, 0.6);
    }

    @media (max-width: 720px) {
      body {
        padding: 32px 16px;
      }

      .container {
        padding: 32px 22px;
      }

      .section {
        padding: 22px;
      }

      .checkpoint-item {
        grid-template-columns: 1fr;
        text-align: left;
      }

      .button-group {
        grid-template-columns: 1fr;
      }
    }

    /* Light mode adjustments */
    body.light-mode {
      background: var(--bg-gradient-light);
      color: var(--text-primary-light);
    }

    body.light-mode .container {
      background: var(--card-bg-light);
      border-color: var(--border-light);
      box-shadow: var(--shadow-light);
    }

    body.light-mode .welcome-subtitle,
    body.light-mode .stat-label,
    body.light-mode #activeWalkInfo p,
    body.light-mode .cta-hint {
      color: var(--text-muted-light);
    }

    body.light-mode .section {
      background: rgba(255, 255, 255, 0.82);
      border-color: rgba(41, 76, 155, 0.12);
    }

    body.light-mode .section:hover {
      box-shadow: 0 16px 40px rgba(40, 74, 142, 0.16);
    }

    body.light-mode .stat-card {
      background: rgba(79, 139, 255, 0.06);
      border-color: rgba(79, 139, 255, 0.12);
    }

    body.light-mode .stat-card:hover {
      border-color: rgba(79, 139, 255, 0.32);
    }

    body.light-mode .checkpoint-item {
      background: rgba(79, 139, 255, 0.08);
      border-color: rgba(79, 139, 255, 0.16);
    }

    body.light-mode .checkpoint-item:hover {
      border-color: rgba(79, 139, 255, 0.36);
    }

    body.light-mode .status-pill.inactive {
      color: var(--text-muted-light);
      background: rgba(41, 76, 155, 0.1);
      border-color: rgba(41, 76, 155, 0.16);
    }

    body.light-mode #noActiveWalkMessage {
      background: rgba(255, 255, 255, 0.88);
      border-color: rgba(41, 76, 155, 0.24);
      color: var(--text-muted-light);
    }

    body.light-mode .action-btn.secondary {
      background: rgba(41, 76, 155, 0.08);
      color: var(--text-primary-light);
      border-color: rgba(41, 76, 155, 0.18);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="dashboard-header">
      <div>
        <h2 id="welcomeMessage">Welcome, Officer!</h2>
        <p class="welcome-subtitle">Stay sharp out there—every checkpoint keeps the campus safe.</p>
      </div>
      <span id="patrolStatusPill" class="status-pill inactive">Off Duty</span>
    </div>

    <div id="activeWalkSection" class="section">
      <h3 class="section-title">Active Patrol Details</h3>
      <div id="activeWalkInfo">
        <p><strong>Walk ID:</strong> <span id="walkIdDisplay">N/A</span></p>
        <p><strong>Started:</strong> <span id="walkStartTimeDisplay">N/A</span></p>
      </div>

      <div class="overview-grid">
        <div class="stat-card">
          <span class="stat-label">Total Checkpoints</span>
          <span class="stat-value" id="summaryTotal">0</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Completed</span>
          <span class="stat-value accent-green" id="summaryCompleted">0</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Pending</span>
          <span class="stat-value accent-amber" id="summaryPending">0</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Last Checkpoint</span>
          <span class="stat-value" id="lastCheckpointDisplay">—</span>
        </div>
      </div>

      <p class="section-title" style="margin-top: 4px;">Progress</p>
      <div class="progress-container">
        <div id="progressBar">0%</div>
      </div>

      <h4 class="section-title" style="margin-top: 24px;">Checkpoint Timeline</h4>
      <ul id="checkpointsList"></ul>
    </div>

    <div id="noActiveWalkMessage" class="section">
      <div>
        <p>No active patrol at the moment.</p>
        <p class="cta-hint">Start a new walk when you're ready to begin your next round.</p>
      </div>
    </div>

    <div class="button-group">
      <button id="startPatrolButton" class="action-btn">Start Morning Patrol</button>
      <button id="scanQrButton" class="action-btn secondary">Scan QR Code</button>
      <button id="cancelWalkButton" class="action-btn secondary">Cancel Current Walk</button>
      <button id="logoutButton" class="action-btn secondary">Logout</button>
    </div>
  </div>

  <script src="../scripts/data.js"></script>
  <script src="../scripts/app.js"></script>
  <script src="../scripts/theme.js" defer></script>
  <script>
    let currentUser = null;
    let activeWalk = null;
    let qrCodesCache = {};

    document.addEventListener('DOMContentLoaded', function() {
      if (typeof initializeData === 'function') {
        initializeData();
      }

      const qrCodes = typeof getQrCodes === 'function' ? getQrCodes() : [];
      qrCodes.forEach(qr => qrCodesCache[qr.id] = qr);

      if (typeof getCurrentUser !== 'function') {
        alert("Error accessing user session. Please refresh.");
        return;
      }

      currentUser = getCurrentUser();

      if (!currentUser) {
        alert("You are not logged in. Redirecting to login page.");
        window.location.href = '../pages/user-login.html';
        return;
      }

      document.getElementById('welcomeMessage').textContent = `Welcome, ${currentUser.username}!`;
      document.getElementById('startPatrolButton').addEventListener('click', handleStartPatrol);
      document.getElementById('scanQrButton').addEventListener('click', () => {
        if (activeWalk) window.location.href = 'qr-scan.html';
        else alert("No active walk to scan QR codes for.");
      });
      document.getElementById('cancelWalkButton').addEventListener('click', handleCancelWalkRequest);
      document.getElementById('logoutButton').addEventListener('click', handleLogout);

      renderDashboard();
    });

    function renderDashboard() {
      activeWalk = getActiveWalkForUser(currentUser.username);

      const activeWalkSection = document.getElementById('activeWalkSection');
      const noActiveWalkMessage = document.getElementById('noActiveWalkMessage');
      const startPatrolButton = document.getElementById('startPatrolButton');
      const scanQrButton = document.getElementById('scanQrButton');
      const cancelWalkButton = document.getElementById('cancelWalkButton');
      const checkpointsList = document.getElementById('checkpointsList');
      const progressBar = document.getElementById('progressBar');
      const statusPill = document.getElementById('patrolStatusPill');
      const summaryTotal = document.getElementById('summaryTotal');
      const summaryCompleted = document.getElementById('summaryCompleted');
      const summaryPending = document.getElementById('summaryPending');
      const lastCheckpointDisplay = document.getElementById('lastCheckpointDisplay');

      checkpointsList.innerHTML = '';
      progressBar.style.width = '0%';
      progressBar.textContent = '0%';
      document.getElementById('walkIdDisplay').textContent = 'N/A';
      document.getElementById('walkStartTimeDisplay').textContent = 'N/A';
      summaryTotal.textContent = '0';
      summaryCompleted.textContent = '0';
      summaryPending.textContent = '0';
      lastCheckpointDisplay.textContent = '—';

      if (activeWalk) {
        activeWalkSection.style.display = 'block';
        noActiveWalkMessage.style.display = 'none';
        scanQrButton.style.display = 'inline-block';
        cancelWalkButton.style.display = 'inline-block';
        startPatrolButton.style.display = 'none';

        statusPill.textContent = 'Active Patrol';
        statusPill.classList.add('active');
        statusPill.classList.remove('inactive');

        document.getElementById('walkIdDisplay').textContent = activeWalk.id;
        document.getElementById('walkStartTimeDisplay').textContent = new Date(activeWalk.startTime).toLocaleString();

        const totalCheckpoints = Array.isArray(activeWalk.checkpointScans) ? activeWalk.checkpointScans.length : 0;
        const completedCount = Array.isArray(activeWalk.checkpointScans)
          ? activeWalk.checkpointScans.filter(cp => cp.status === 'COMPLETED').length
          : 0;
        const pendingCount = Math.max(totalCheckpoints - completedCount, 0);

        summaryTotal.textContent = totalCheckpoints;
        summaryCompleted.textContent = completedCount;
        summaryPending.textContent = pendingCount;

        const progress = calculateWalkProgress(activeWalk.id);
        progressBar.style.width = `${progress}%`;
        progressBar.textContent = `${progress}%`;

        const lastCheckpoint = Array.isArray(activeWalk.checkpointScans)
          ? [...activeWalk.checkpointScans].reverse().find(cp => cp.scannedAt)
          : null;
        if (lastCheckpoint) {
          const qrCodeName = qrCodesCache[lastCheckpoint.checkpointId]?.name || lastCheckpoint.checkpointId;
          const time = new Date(lastCheckpoint.scannedAt).toLocaleTimeString();
          lastCheckpointDisplay.textContent = `${qrCodeName} (${time})`;
        } else if (totalCheckpoints > 0) {
          lastCheckpointDisplay.textContent = 'Awaiting first scan';
        }

        if (activeWalk.checkpointScans?.length > 0) {
          activeWalk.checkpointScans.forEach(cpScan => {
            const li = document.createElement('li');
            li.classList.add('checkpoint-item');

            const qrCodeName = qrCodesCache[cpScan.checkpointId]?.name || cpScan.checkpointId;
            let scannedTime = '';
            if (cpScan.scannedAt) {
              scannedTime = `<span class="timestamp">(${new Date(cpScan.scannedAt).toLocaleTimeString()})</span>`;
            }

            li.innerHTML = `
              <span class="name">${qrCodeName}</span>
              <span class="status-${cpScan.status.toLowerCase()}">${cpScan.status.replace('_', ' ')} ${scannedTime}</span>
            `;
            checkpointsList.appendChild(li);
          });
        } else {
          checkpointsList.innerHTML = '<li class="checkpoint-item">No checkpoints defined for this walk.</li>';
        }
      } else {
        activeWalkSection.style.display = 'none';
        noActiveWalkMessage.style.display = 'flex';
        scanQrButton.style.display = 'none';
        cancelWalkButton.style.display = 'none';
        startPatrolButton.style.display = 'inline-block';

        statusPill.textContent = 'Off Duty';
        statusPill.classList.remove('active');
        statusPill.classList.add('inactive');
      }
    }

    function handleStartPatrol() {
      if (!currentUser || typeof startWalk !== 'function') {
        alert("Error: Cannot start patrol. Required functions missing.");
        return;
      }

      const newWalk = startWalk(currentUser.username, 'WT01');
      if (newWalk) {
        alert(`Patrol ${newWalk.id} started successfully!`);
        renderDashboard();
      } else {
        alert("Failed to start patrol. Make sure template ID 'WT01' exists.");
      }
    }

    function handleCancelWalkRequest() {
      if (!activeWalk) {
        alert("No active walk to cancel.");
        return;
      }

      const confirmCancel = confirm("Are you sure you want to cancel the current walk?");
      if (!confirmCancel) return;

      const success = cancelWalk(activeWalk.id);
      if (success) {
        alert("Walk cancelled successfully.");
        renderDashboard();
      } else {
        alert("Failed to cancel the walk. Please try again.");
      }
    }

    function handleLogout() {
      if (typeof logout !== 'function') {
        alert("Error logging out. Please clear your session manually.");
        return;
      }

      logout();
      window.location.href = '../pages/user-login.html';
    }
  </script>
</body>
</html>
