<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>User Dashboard - Secure Walkways</title>
  <style>
    /* Base styles */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background-color 0.3s, color 0.3s;
    }
    .container {
      width: 100%;
      max-width: 700px;
      padding: 25px;
      border-radius: 10px;
      transition: background-color 0.3s, box-shadow 0.3s;
    }
    h2#welcomeMessage { text-align: center; margin-bottom: 25px; transition: color 0.3s; }
    .section {
      margin-bottom: 25px;
      padding: 15px;
      border-radius: 8px;
      transition: background-color 0.3s;
    }
    .section-title {
      margin-top: 0;
      margin-bottom: 15px;
      padding-bottom: 5px;
      transition: color 0.3s, border-bottom-color 0.3s;
    }
    #activeWalkInfo p, #noActiveWalkMessage p { margin: 5px 0; font-size: 0.95em; }
    .progress-container {
      width: 100%;
      border-radius: 5px;
      margin-bottom: 15px;
      height: 25px;
      display: flex;
      align-items: center;
      transition: background-color 0.3s;
    }
    #progressBar {
      width: 0%;
      height: 100%;
      border-radius: 5px;
      transition: width 0.3s ease-in-out, background-color 0.3s;
      text-align: center;
      line-height: 25px;
      font-weight: bold;
    }
    #checkpointsList { list-style: none; padding: 0; }
    .checkpoint-item {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9em;
      transition: background-color 0.3s;
    }
    .checkpoint-item .name { font-weight: bold; }
    .checkpoint-item .timestamp { font-size: 0.8em; margin-left: 10px; transition: color 0.3s; }
    .button-group { display: flex; justify-content: space-around; flex-wrap: wrap; margin-top: 20px; }
    .action-btn {
      padding: 12px 18px;
      font-size: 1em;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      margin: 5px;
      font-weight: bold; /* Added for consistency */
    }

    /* Dark Mode (current default) */
    body.dark-mode { background-color: #1a1a1a; color: #e0e0e0; }
    .dark-mode .container { background-color: #2c2c2c; box-shadow: 0 0 15px rgba(0,0,0,0.5); }
    .dark-mode h2#welcomeMessage { color: #00acc1; }
    .dark-mode .section { background-color: #333333; }
    .dark-mode .section-title { color: #00acc1; border-bottom: 1px solid #00acc1; }
    .dark-mode .progress-container { background-color: #444; }
    .dark-mode #progressBar { background-color: #007bff; color: white; }
    .dark-mode .checkpoint-item { background-color: #3a3a3a; color: #e0e0e0; }
    .dark-mode .checkpoint-item .status-pending { color: #ffc107; }
    .dark-mode .checkpoint-item .status-scanned { color: #28a745; }
    .dark-mode .checkpoint-item .status-missed { color: #dc3545; }
    .dark-mode .checkpoint-item .status-cancelled_walk { color: #6c757d; }
    .dark-mode .checkpoint-item .timestamp { color: #ccc; }
    .dark-mode .action-btn { color: white; } /* Default for dark mode buttons */
    .dark-mode #startPatrolButton { background-color: #28a745; }
    .dark-mode #startPatrolButton:hover { background-color: #218838; }
    .dark-mode #scanQrButton { background-color: #007bff; }
    .dark-mode #scanQrButton:hover { background-color: #0056b3; }
    .dark-mode #cancelWalkButton { background-color: #dc3545; }
    .dark-mode #cancelWalkButton:hover { background-color: #c82333; }
    .dark-mode #logoutButton { background-color: #6c757d; }
    .dark-mode #logoutButton:hover { background-color: #5a6268; }

    /* Light Mode */
    body.light-mode { background-color: #f0f2f5; color: #333; }
    .light-mode .container { background-color: #fff; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
    .light-mode h2#welcomeMessage { color: #007bff; } /* Blue for light mode welcome */
    .light-mode .section { background-color: #e9ecef; }
    .light-mode .section-title { color: #007bff; border-bottom: 1px solid #007bff; }
    .light-mode .progress-container { background-color: #ccc; }
    .light-mode #progressBar { background-color: #0056b3; color: white; } /* Darker blue for progress */
    .light-mode .checkpoint-item { background-color: #f8f9fa; color: #333; border-left: 3px solid #007bff; }
    .light-mode .checkpoint-item .status-pending { color: #e0a800; } /* Darker yellow */
    .light-mode .checkpoint-item .status-scanned { color: #1e7e34; } /* Darker green */
    .light-mode .checkpoint-item .status-missed { color: #c82333; } /* Darker red */
    .light-mode .checkpoint-item .status-cancelled_walk { color: #5a6268; } /* Darker grey */
    .light-mode .checkpoint-item .timestamp { color: #555; }
    .light-mode .action-btn { color: white; } /* Default for light mode buttons, specific bg below */
    .light-mode #startPatrolButton { background-color: #218838; }
    .light-mode #startPatrolButton:hover { background-color: #1e7e34; }
    .light-mode #scanQrButton { background-color: #0056b3; }
    .light-mode #scanQrButton:hover { background-color: #004085; }
    .light-mode #cancelWalkButton { background-color: #c82333; }
    .light-mode #cancelWalkButton:hover { background-color: #a71d2a; }
    .light-mode #logoutButton { background-color: #5a6268; }
    .light-mode #logoutButton:hover { background-color: #495057; }

    /* Hide elements by default, show via JS */
    #activeWalkSection, #scanQrButton, #cancelWalkButton { display: none; }
    #noActiveWalkMessage, #startPatrolButton { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h2 id="welcomeMessage">Welcome, Officer!</h2>

    <div id="activeWalkSection" class="section">
      <h3 class="section-title">Active Patrol Details</h3>
      <div id="activeWalkInfo">
        <p><strong>Walk ID:</strong> <span id="walkIdDisplay">N/A</span></p>
        <p><strong>Started:</strong> <span id="walkStartTimeDisplay">N/A</span></p>
      </div>
      <p><strong>Progress:</strong></p>
      <div class="progress-container">
        <div id="progressBar">0%</div>
      </div>
      <h4 class="section-title" style="margin-top: 20px;">Checkpoints:</h4>
      <ul id="checkpointsList">
        <!-- Checkpoints will be dynamically inserted here -->
      </ul>
    </div>

    <div id="noActiveWalkMessage" class="section" style="text-align: center;">
      <p>No active patrol at the moment.</p>
    </div>

    <div class="button-group">
      <button id="startPatrolButton" class="action-btn">Start Morning Patrol</button>
      <button id="scanQrButton" class="action-btn">Scan QR Code</button>
      <button id="cancelWalkButton" class="action-btn">Cancel Current Walk</button>
      <button id="logoutButton" class="action-btn">Logout</button>
    </div>
  </div>

  <script src="../scripts/data.js"></script>
  <script src="../scripts/app.js"></script>
  <script src="../scripts/theme.js" defer></script>
  <script>
    let currentUser = null;
    let activeWalk = null;
    let qrCodesCache = {}; // For storing QR code names by ID

    document.addEventListener('DOMContentLoaded', function() {
      // 1. Initialize data and QR cache
      if (typeof initializeData === 'function') {
        initializeData(); // From data.js
      } else {
        console.error("initializeData function not found. Ensure data.js is loaded.");
        alert("Error initializing application data. Please refresh.");
        return;
      }
      
      const qrCodes = typeof getQrCodes === 'function' ? getQrCodes() : [];
      qrCodes.forEach(qr => qrCodesCache[qr.id] = qr);

      // 2. Check user authentication
      if (typeof getCurrentUser !== 'function') {
        console.error("getCurrentUser function not found. Ensure app.js is loaded.");
        alert("Error accessing user session. Please refresh.");
        return;
      }
      currentUser = getCurrentUser();

      if (!currentUser) {
        alert("You are not logged in. Redirecting to login page.");
        window.location.href = '../pages/user-login.html'; // Adjust if index.html is the main entry
        return;
      }

      // 3. Setup UI elements and event listeners
      document.getElementById('welcomeMessage').textContent = `Welcome, ${currentUser.username}!`;
      
      document.getElementById('startPatrolButton').addEventListener('click', handleStartPatrol);
      document.getElementById('scanQrButton').addEventListener('click', () => {
        if (activeWalk) window.location.href = 'qr-scan.html'; // Redirect to QR scan page
        else alert("No active walk to scan QR codes for.");
      });
      document.getElementById('cancelWalkButton').addEventListener('click', handleCancelWalkRequest);
      document.getElementById('logoutButton').addEventListener('click', handleLogout);

      // 4. Initial dashboard render
      renderDashboard();
    });

    function renderDashboard() {
      if (!currentUser || typeof getActiveWalkForUser !== 'function' || typeof calculateWalkProgress !== 'function') {
        console.error("Required functions or current user not available for rendering dashboard.");
        return;
      }
      activeWalk = getActiveWalkForUser(currentUser.username);

      const activeWalkSection = document.getElementById('activeWalkSection');
      const noActiveWalkMessage = document.getElementById('noActiveWalkMessage');
      const startPatrolButton = document.getElementById('startPatrolButton');
      const scanQrButton = document.getElementById('scanQrButton');
      const cancelWalkButton = document.getElementById('cancelWalkButton');
      const checkpointsList = document.getElementById('checkpointsList');
      const progressBar = document.getElementById('progressBar');
      
      // Clear previous state
      checkpointsList.innerHTML = '';
      progressBar.style.width = '0%';
      progressBar.textContent = '0%';
      document.getElementById('walkIdDisplay').textContent = 'N/A';
      document.getElementById('walkStartTimeDisplay').textContent = 'N/A';

      if (activeWalk) {
        activeWalkSection.style.display = 'block';
        noActiveWalkMessage.style.display = 'none';
        scanQrButton.style.display = 'inline-block';
        cancelWalkButton.style.display = 'inline-block';
        startPatrolButton.style.display = 'none';

        document.getElementById('walkIdDisplay').textContent = activeWalk.id;
        document.getElementById('walkStartTimeDisplay').textContent = new Date(activeWalk.startTime).toLocaleString();

        const progress = calculateWalkProgress(activeWalk.id);
        progressBar.style.width = `${progress}%`;
        progressBar.textContent = `${progress}%`;

        if (activeWalk.checkpointScans && activeWalk.checkpointScans.length > 0) {
          activeWalk.checkpointScans.forEach(cpScan => {
            const li = document.createElement('li');
            li.classList.add('checkpoint-item');
            
            const qrCodeName = qrCodesCache[cpScan.checkpointId]?.name || cpScan.checkpointId;
            let scannedTime = '';
            if (cpScan.scannedAt) {
              scannedTime = `<span class="timestamp">(${new Date(cpScan.scannedAt).toLocaleTimeString()})</span>`;
            }
            
            li.innerHTML = `
              <span class="name">${qrCodeName}</span>
              <span class="status-${cpScan.status.toLowerCase()}">${cpScan.status.replace('_', ' ')} ${scannedTime}</span>
            `;
            checkpointsList.appendChild(li);
          });
        } else {
          checkpointsList.innerHTML = '<li class="checkpoint-item">No checkpoints defined for this walk.</li>';
        }
      } else {
        activeWalkSection.style.display = 'none';
        noActiveWalkMessage.style.display = 'block';
        scanQrButton.style.display = 'none';
        cancelWalkButton.style.display = 'none';
        startPatrolButton.style.display = 'inline-block';
      }
    }

    function handleStartPatrol() {
      if (!currentUser || typeof startWalk !== 'function') {
        alert("Error: Cannot start patrol. User or required function not available.");
        return;
      }
      // Using 'WT01' as the default morning patrol template ID
      const newWalk = startWalk(currentUser.username, 'WT01');
      if (newWalk) {
        alert(`Patrol ${newWalk.id} started successfully!`);
        renderDashboard(); // Re-render to show the new active walk
      } else {
        alert("Failed to start patrol. Please check console for errors or ensure template 'WT01' exists.");
      }
    }

    function handleCancelWalkRequest() {
      if (!activeWalk) {
        alert("No active walk to cancel.");
        return;
      }
      const reason = prompt("Please enter the reason for cancelling this walk:");
      if (reason && reason.trim() !== "") {
        if (typeof cancelUserWalk !== 'function') {
          alert("Error: Cancel function not available.");
          return;
        }
        const cancelledWalk = cancelUserWalk(activeWalk.id, reason.trim());
        if (cancelledWalk) {
          alert(`Walk ${cancelledWalk.id} has been cancelled.`);
          renderDashboard(); // Re-render to update UI
        } else {
          alert("Failed to cancel walk. Please check console for errors.");
        }
      } else if (reason !== null) { // User didn't click "Cancel" on prompt, but left it empty
        alert("Cancellation reason cannot be empty.");
      }
    }

    function handleLogout() {
      if (typeof logoutUser === 'function') {
        logoutUser(); // This function in app.js handles logging and redirection
      } else {
        alert("Logout function not available. Please clear session manually or refresh.");
        // Fallback redirect if function is missing
        localStorage.removeItem('currentUser'); // Basic cleanup
        window.location.href = '../index.html';
      }
    }
  </script>
</body>
</html>