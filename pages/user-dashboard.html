<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0b152d">
  <title>User Dashboard - Secure Walkways</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <link rel="stylesheet" href="../styles/main.css">
</head>
<body>
  <main class="container">
    <header class="section">
      <h2 id="welcomeMessage">Welcome, Officer!</h2>
      <p class="subtitle">Monitor your patrol progress, scan checkpoints, and finish strong.</p>
    </header>

    <section id="activeWalkSection" class="section" style="display: none;">
      <h3 class="section-title">Active Patrol Details</h3>
      <div id="activeWalkInfo">
        <p><strong>Walk ID:</strong> <span id="walkIdDisplay">N/A</span></p>
        <p><strong>Started:</strong> <span id="walkStartTimeDisplay">N/A</span></p>
      </div>
      <p class="section-title">Progress</p>
      <div class="progress-container">
        <span id="progressBar">0%</span>
      </div>
      <h4 class="section-title" style="margin-top: 20px;">Checkpoints</h4>
      <ul id="checkpointsList"></ul>
    </section>

    <section id="noActiveWalkMessage" class="section" style="text-align: center;">
      <p>No active patrol at the moment.</p>
    </section>

    <div class="button-group">
      <button id="startPatrolButton" class="action-btn">Start Morning Patrol</button>
      <button id="scanQrButton" class="action-btn">Scan QR Code</button>
      <button id="cancelWalkButton" class="action-btn danger">Cancel Current Walk</button>
      <button id="logoutButton" class="action-btn secondary">Logout</button>
    </div>
  </main>

  <script src="../scripts/data.js"></script>
  <script src="../scripts/app.js"></script>
  <script src="../scripts/theme.js" defer></script>
  <script>
    let currentUser = null;
    let activeWalk = null;
    let isLoading = false;

    document.addEventListener('DOMContentLoaded', function() {
      if (typeof getCurrentUser !== 'function') {
        alert('Error accessing user session. Please refresh.');
        return;
      }

      currentUser = getCurrentUser();

      if (!currentUser) {
        alert('You are not logged in. Redirecting to login page.');
        window.location.href = '../pages/user-login.html';
        return;
      }

      document.getElementById('welcomeMessage').textContent = `Welcome, ${currentUser.username}!`;
      document.getElementById('startPatrolButton').addEventListener('click', () => {
        handleStartPatrol().catch(error => {
          console.error('Error starting patrol:', error);
          alert('Unexpected error starting patrol.');
        });
      });
      document.getElementById('scanQrButton').addEventListener('click', () => {
        if (activeWalk) window.location.href = 'qr-scan.html';
        else alert('No active walk to scan QR codes for.');
      });
      document.getElementById('cancelWalkButton').addEventListener('click', () => {
        handleCancelWalkRequest().catch(error => {
          console.error('Error cancelling walk:', error);
          alert('Unexpected error cancelling walk.');
        });
      });
      document.getElementById('logoutButton').addEventListener('click', handleLogout);

      renderDashboard().catch(error => {
        console.error('Error rendering dashboard:', error);
        alert('Unable to load dashboard. Please refresh.');
      });
    });

    async function renderDashboard() {
      if (isLoading) {
        return;
      }
      isLoading = true;

      try {
        activeWalk = await getActiveWalkForUser(currentUser.username);
      } finally {
        isLoading = false;
      }

      const activeWalkSection = document.getElementById('activeWalkSection');
      const noActiveWalkMessage = document.getElementById('noActiveWalkMessage');
      const startPatrolButton = document.getElementById('startPatrolButton');
      const scanQrButton = document.getElementById('scanQrButton');
      const cancelWalkButton = document.getElementById('cancelWalkButton');
      const checkpointsList = document.getElementById('checkpointsList');
      const progressBar = document.getElementById('progressBar');

      checkpointsList.innerHTML = '';
      progressBar.style.width = '0%';
      progressBar.textContent = '0%';
      document.getElementById('walkIdDisplay').textContent = 'N/A';
      document.getElementById('walkStartTimeDisplay').textContent = 'N/A';

      if (activeWalk) {
        activeWalkSection.style.display = 'block';
        noActiveWalkMessage.style.display = 'none';
        scanQrButton.style.display = 'inline-flex';
        cancelWalkButton.style.display = 'inline-flex';
        startPatrolButton.style.display = 'none';

        document.getElementById('walkIdDisplay').textContent = activeWalk.id;
        const startTime = activeWalk.start_time || activeWalk.startTime;
        document.getElementById('walkStartTimeDisplay').textContent = startTime ? new Date(startTime).toLocaleString() : 'N/A';

        const progress = calculateWalkProgress(activeWalk);
        progressBar.style.width = `${progress}%`;
        progressBar.textContent = `${progress}%`;

        if (Array.isArray(activeWalk.checkpoints) && activeWalk.checkpoints.length > 0) {
          activeWalk.checkpoints.forEach(cp => {
            const li = document.createElement('li');
            li.classList.add('checkpoint-item');

            const checkpointName = cp.name || cp.qr_code_identifier || 'Checkpoint';
            let scannedTime = '';
            if (cp.scanned_at) {
              scannedTime = `<span class="timestamp">(${new Date(cp.scanned_at).toLocaleTimeString()})</span>`;
            }

            li.innerHTML = `
              <span class="name">${checkpointName}</span>
              <span class="status-${cp.status.toLowerCase()}">${cp.status.replace(/_/g, ' ')} ${scannedTime}</span>
            `;
            checkpointsList.appendChild(li);
          });
        } else {
          checkpointsList.innerHTML = '<li class="checkpoint-item">No checkpoints defined for this walk.</li>';
        }
      } else {
        activeWalkSection.style.display = 'none';
        noActiveWalkMessage.style.display = 'block';
        scanQrButton.style.display = 'none';
        cancelWalkButton.style.display = 'none';
        startPatrolButton.style.display = 'inline-flex';
      }
    }

    async function handleStartPatrol() {
      if (!currentUser || typeof startWalk !== 'function') {
        alert('Error: Cannot start patrol. Required functions missing.');
        return;
      }

      const newWalk = await startWalk(currentUser.username, 'WT01');
      if (newWalk) {
        alert(`Patrol ${newWalk.id} started successfully!`);
        await renderDashboard();
      } else {
        alert('Failed to start patrol. Ensure checkpoints are configured in the system.');
      }
    }

    async function handleCancelWalkRequest() {
      if (!activeWalk) {
        alert('No active walk to cancel.');
        return;
      }

      const reason = prompt('Enter reason for cancelling this walk:');
      if (reason && reason.trim() !== '') {
        const cancelledWalk = await cancelUserWalk(activeWalk.id, reason.trim());
        if (cancelledWalk) {
          alert(`Walk ${cancelledWalk.id} has been cancelled.`);
          await renderDashboard();
        } else {
          alert('Failed to cancel walk. Check console.');
        }
      } else if (reason !== null) {
        alert('Cancellation reason cannot be empty.');
      }
    }

    function handleLogout() {
      if (typeof logoutUser === 'function') {
        logoutUser();
      } else {
        localStorage.removeItem('currentUser');
        window.location.href = '../index.html';
      }
    }
  </script>
</body>
</html>
