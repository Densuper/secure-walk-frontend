<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR Code Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0b152d">
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <link rel="stylesheet" href="../styles/main.css">
</head>
<body>
  <main class="container">
    <header class="section" style="text-align: center;">
      <h1>Scan QR Code</h1>
      <p class="subtitle">Align the checkpoint QR within the frame to confirm your patrol stop.</p>
    </header>

    <section class="section" style="text-align: center;">
      <div id="reader" style="display: none;"></div>
      <div id="scanResult" class="scan-info">Initializing scanner...</div>
      <button class="btn-back secondary" onclick="goBack()" style="margin-top: 24px;">‚Üê Back to Dashboard</button>
    </section>
  </main>

  <script src="../scripts/data.js"></script>
  <script src="../scripts/app.js"></script>
  <script src="../scripts/theme.js" defer></script>
  <script>
    let currentUser = null;
    let activeWalk = null;
    let html5QrCode = null;

    function goBack() {
      if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.stop().catch(err => console.error('Error stopping scanner:', err));
      }
      window.location.href = 'user-dashboard.html';
    }

    document.addEventListener('DOMContentLoaded', async function() {
      const readerDiv = document.getElementById('reader');
      const scanResultDiv = document.getElementById('scanResult');

      currentUser = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
      if (!currentUser) {
        scanResultDiv.textContent = 'User not logged in. Please login from the dashboard.';
        scanResultDiv.className = 'scan-error';
        return;
      }

      if (typeof getActiveWalkForUser === 'function') {
        try {
          activeWalk = await getActiveWalkForUser(currentUser.username);
        } catch (error) {
          console.error('Error loading active walk for scanner:', error);
        }
      }
      if (!activeWalk) {
        scanResultDiv.textContent = 'No active patrol found. Please start a patrol from the dashboard.';
        scanResultDiv.className = 'scan-error';
        return;
      }

      readerDiv.style.display = 'block';
      scanResultDiv.textContent = 'Scanner ready. Point at a QR code.';
      scanResultDiv.className = 'scan-info';

      html5QrCode = new Html5Qrcode('reader');
      const qrConfig = { fps: 10, qrbox: { width: 250, height: 250 } };

      html5QrCode.start(
        { facingMode: 'environment' },
        qrConfig,
        onScanSuccess,
        onScanFailure
      ).catch(err => {
        scanResultDiv.textContent = 'Camera initialization failed: ' + err;
        scanResultDiv.className = 'scan-error';
        readerDiv.style.display = 'none';
      });
    });

    async function onScanSuccess(decodedText, decodedResult) {
      const scanResultDiv = document.getElementById('scanResult');
      if (!activeWalk) {
        scanResultDiv.textContent = 'Error: No active walk context. Please return to dashboard.';
        scanResultDiv.className = 'scan-error';
        if (html5QrCode && html5QrCode.isScanning) html5QrCode.stop().catch(e => console.error(e));
        return;
      }

      const scanTime = new Date().toISOString();
      const updateResult = await updateCheckpointStatus(activeWalk.id, decodedText, scanTime);

      if (updateResult && updateResult.success) {
        const checkpointDetail = Array.isArray(activeWalk.checkpoints)
          ? activeWalk.checkpoints.find(cp => cp.qr_code_identifier === decodedText)
          : null;
        const checkpointName = checkpointDetail?.name || decodedText;

        scanResultDiv.textContent = `Checkpoint '${checkpointName}' scanned successfully!`;
        scanResultDiv.className = 'scan-success';

        try {
          activeWalk = await getActiveWalkForUser(currentUser.username);
        } catch (error) {
          console.error('Error refreshing active walk after scan:', error);
        }

        if (updateResult.walkCompleted) {
          scanResultDiv.textContent += ' Walk complete! All checkpoints scanned. Redirecting to dashboard...';
          if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().then(() => {
              console.log('Scanner stopped due to walk completion.');
            }).catch(err => console.error('Error stopping scanner after walk completion:', err));
          }
          setTimeout(() => {
            window.location.href = 'user-dashboard.html';
          }, 3000);
        }
      } else {
        if (updateResult && updateResult.alreadyScanned) {
          scanResultDiv.textContent = updateResult.message || `Checkpoint already scanned: ${decodedText}`;
          scanResultDiv.className = 'scan-info';
        } else {
          scanResultDiv.textContent = 'Error: ' + (updateResult?.message || `Invalid QR Code (${decodedText}) for this patrol.`);
          scanResultDiv.className = 'scan-error';
        }
      }
    }

    function onScanFailure(error) {
      // Silent on frame misses
    }
  </script>
</body>
</html>
