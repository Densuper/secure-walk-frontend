<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0b152d">
  <title>QR Code Management</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <link rel="stylesheet" href="../styles/main.css">
</head>
<body>
  <main class="container">
    <header class="section">
      <h1>QR Code Management</h1>
      <p class="admin-welcome" id="adminWelcomeMessage"></p>
    </header>

    <div id="qrCodeListContainer" class="section">
      <!-- QR Codes will be dynamically inserted here -->
    </div>

    <button id="showAddQrCodeFormButton" class="action-btn" type="button">Add New QR Code</button>

    <section id="qrCodeFormWrapper" class="section" style="display: none;">
      <h2 id="formTitle">Add New QR Code</h2>
      <form id="qrCodeForm" novalidate>
        <input type="hidden" id="editModeQrId" value="">
        <div class="form-group">
          <label for="qrId">QR Code ID</label>
          <input type="text" id="qrId" name="qrId" required>
        </div>
        <div class="form-group">
          <label for="qrName">Name</label>
          <input type="text" id="qrName" name="qrName" required>
        </div>
        <div class="form-group">
          <label for="qrLocation">Location</label>
          <input type="text" id="qrLocation" name="qrLocation">
        </div>
        <div class="form-buttons">
          <button type="submit" id="saveQrCodeButton">Save QR Code</button>
          <button type="button" id="cancelFormButton" class="secondary">Cancel</button>
        </div>
      </form>
    </section>

    <div class="action-buttons">
      <a href="admin-dashboard.html" class="back-btn secondary">‚Üê Back to Admin Dashboard</a>
    </div>
  </main>

  <script src="../scripts/data.js"></script>
  <script src="../scripts/app.js"></script>
  <script src="../scripts/theme.js" defer></script>
  <script>
    let currentAdminUser = null;

    document.addEventListener('DOMContentLoaded', function() {
      if (typeof initializeData === 'function') initializeData();

      currentAdminUser = typeof getCurrentUser === 'function' ? getCurrentUser() : null;

      if (!currentAdminUser || currentAdminUser.role !== 'admin') {
        alert('Access Denied. You must be an admin to manage QR codes.');
        window.location.href = 'admin-login.html';
        return;
      }
      document.getElementById('adminWelcomeMessage').textContent = `Logged in as: Admin ${currentAdminUser.username}`;

      renderQrCodeList();

      document.getElementById('showAddQrCodeFormButton').addEventListener('click', showAddForm);
      document.getElementById('qrCodeForm').addEventListener('submit', handleQrCodeFormSubmit);
      document.getElementById('cancelFormButton').addEventListener('click', hideQrCodeForm);
      document.getElementById('qrCodeListContainer').addEventListener('click', handleQrCodeListActions);
    });

    function renderQrCodeList() {
      const qrCodeListContainer = document.getElementById('qrCodeListContainer');
      qrCodeListContainer.innerHTML = '';
      const qrCodes = getQrCodes();

      if (qrCodes.length === 0) {
        qrCodeListContainer.innerHTML = '<p class="muted">No QR codes found.</p>';
        return;
      }

      qrCodes.forEach(qr => {
        const qrDiv = document.createElement('div');
        qrDiv.className = 'qr-code-entry';
        qrDiv.innerHTML = `
          <div class="info">
            <span><strong>ID:</strong> ${qr.id}</span>
            <span><strong>Name:</strong> ${qr.name}</span>
            <span><strong>Location:</strong> ${qr.location || 'N/A'}</span>
          </div>
          <div class="actions">
            <button class="edit-btn secondary" data-qr-id="${qr.id}">Edit</button>
            <button class="delete-btn danger" data-qr-id="${qr.id}">Delete</button>
          </div>
        `;
        qrCodeListContainer.appendChild(qrDiv);
      });
    }

    function showAddForm() {
      document.getElementById('formTitle').textContent = 'Add New QR Code';
      document.getElementById('qrCodeForm').reset();
      document.getElementById('editModeQrId').value = '';
      document.getElementById('qrId').disabled = false;
      document.getElementById('qrCodeFormWrapper').style.display = 'block';
    }

    function showEditForm(qrId) {
      const qrCodes = getQrCodes();
      const qrToEdit = qrCodes.find(qr => qr.id === qrId);
      if (!qrToEdit) {
        alert('QR code not found for editing.');
        return;
      }

      document.getElementById('formTitle').textContent = 'Edit QR Code';
      document.getElementById('qrCodeForm').reset();
      document.getElementById('editModeQrId').value = qrToEdit.id;

      const qrIdInput = document.getElementById('qrId');
      qrIdInput.value = qrToEdit.id;
      qrIdInput.disabled = true;

      document.getElementById('qrName').value = qrToEdit.name || '';
      document.getElementById('qrLocation').value = qrToEdit.location || '';
      document.getElementById('qrCodeFormWrapper').style.display = 'block';
    }

    function hideQrCodeForm() {
      document.getElementById('qrCodeFormWrapper').style.display = 'none';
      document.getElementById('qrCodeForm').reset();
      document.getElementById('qrId').disabled = false;
    }

    function handleQrCodeFormSubmit(event) {
      event.preventDefault();

      const qrId = document.getElementById('qrId').value.trim();
      const qrName = document.getElementById('qrName').value.trim();
      const qrLocation = document.getElementById('qrLocation').value.trim();
      const editModeQrId = document.getElementById('editModeQrId').value;

      if (!qrId || !qrName) {
        alert('QR Code ID and Name are required.');
        return;
      }

      if (editModeQrId) {
        const updatedData = { name: qrName, location: qrLocation };
        const result = updateQrCode(editModeQrId, updatedData);
        if (result.success) {
          logEvent(currentAdminUser.username, 'QR_UPDATED', { updatedQrCode: editModeQrId, changes: updatedData });
          alert(`QR Code '${editModeQrId}' updated successfully.`);
        } else {
          alert(`Error updating QR Code: ${result.message}`);
        }
      } else {
        const newQrCode = { id: qrId, name: qrName, location: qrLocation };
        const result = addQrCode(newQrCode);
        if (result.success) {
          logEvent(currentAdminUser.username, 'QR_CREATED', { qrId, name: qrName });
          alert(`QR Code '${qrId}' added successfully.`);
        } else {
          alert(`Error adding QR Code: ${result.message}`);
        }
      }

      renderQrCodeList();
      hideQrCodeForm();
    }

    function handleQrCodeListActions(event) {
      const target = event.target;
      const qrId = target.dataset.qrId;

      if (target.classList.contains('edit-btn')) {
        showEditForm(qrId);
      } else if (target.classList.contains('delete-btn')) {
        if (confirm(`Are you sure you want to delete QR Code '${qrId}'? This action cannot be undone.`)) {
          const result = deleteQrCode(qrId);
          if (result.success) {
            logEvent(currentAdminUser.username, 'QR_DELETED', { deletedQrCode: qrId });
            alert(`QR Code '${qrId}' deleted successfully.`);
            renderQrCodeList();
          } else {
            alert(`Error deleting QR Code: ${result.message}`);
          }
        }
      }
    }
  </script>
</body>
</html>
