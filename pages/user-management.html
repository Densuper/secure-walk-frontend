<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0b152d">
  <title>User Management</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <link rel="stylesheet" href="../styles/main.css">
</head>
<body>
  <main class="container">
    <header class="section">
      <h1>User Management</h1>
      <p class="admin-welcome" id="adminWelcomeMessage"></p>
    </header>

    <div id="userListContainer" class="section">
      <!-- Users populated by script -->
    </div>

    <button id="showAddUserFormButton" class="action-btn" type="button">Add New User</button>

    <section id="userFormWrapper" class="section" style="display: none;">
      <h2 id="formTitle">Add New User</h2>
      <form id="userForm" novalidate>
        <input type="hidden" id="editModeUsername" value="">
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" id="username" name="username" required>
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" name="password">
          <small id="passwordHelp">Leave blank to keep current password (when editing).</small>
        </div>
        <div class="form-group">
          <label for="role">Role</label>
          <select id="role" name="role" required>
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="form-buttons">
          <button type="submit" id="saveUserButton">Save User</button>
          <button type="button" id="cancelFormButton" class="secondary">Cancel</button>
        </div>
      </form>
    </section>

    <div class="action-buttons">
      <a href="admin-dashboard.html" class="back-btn secondary">‚Üê Back to Admin Dashboard</a>
    </div>
  </main>

  <script src="../scripts/data.js"></script>
  <script src="../scripts/app.js"></script>
  <script src="../scripts/theme.js" defer></script>
  <script>
    let currentAdminUser = null;

    document.addEventListener('DOMContentLoaded', function() {
      if (typeof initializeData === 'function') initializeData();

      currentAdminUser = typeof getCurrentUser === 'function' ? getCurrentUser() : null;

      if (!currentAdminUser || currentAdminUser.role !== 'admin') {
        alert('Access Denied. You must be an admin to manage users.');
        window.location.href = 'admin-login.html';
        return;
      }
      document.getElementById('adminWelcomeMessage').textContent = `Logged in as: ${currentAdminUser.username}`;

      renderUserList();

      document.getElementById('showAddUserFormButton').addEventListener('click', showAddForm);
      document.getElementById('userForm').addEventListener('submit', handleUserFormSubmit);
      document.getElementById('cancelFormButton').addEventListener('click', hideUserForm);
      document.getElementById('userListContainer').addEventListener('click', handleUserListActions);
    });

    function renderUserList() {
      const userListContainer = document.getElementById('userListContainer');
      userListContainer.innerHTML = '';
      const users = getUsers();

      if (users.length === 0) {
        userListContainer.innerHTML = '<p class="muted">No users found.</p>';
        return;
      }

      users.forEach(user => {
        const userDiv = document.createElement('div');
        userDiv.className = 'user-entry';
        userDiv.innerHTML = `
          <div class="info">
            <span><strong>Username:</strong> ${user.username}</span>
            <span><strong>Role:</strong> ${user.role}</span>
          </div>
          <div class="actions">
            <button class="edit-btn secondary" data-username="${user.username}">Edit</button>
            <button class="delete-btn danger" data-username="${user.username}">Delete</button>
          </div>
        `;
        userListContainer.appendChild(userDiv);
      });
    }

    function showAddForm() {
      document.getElementById('formTitle').textContent = 'Add New User';
      document.getElementById('userForm').reset();
      document.getElementById('editModeUsername').value = '';
      document.getElementById('username').disabled = false;
      document.getElementById('passwordHelp').style.display = 'none';
      document.getElementById('password').required = true;
      document.getElementById('userFormWrapper').style.display = 'block';
    }

    function showEditForm(username) {
      const users = getUsers();
      const userToEdit = users.find(u => u.username === username);
      if (!userToEdit) {
        alert('User not found for editing.');
        return;
      }

      document.getElementById('formTitle').textContent = 'Edit User';
      document.getElementById('userForm').reset();
      document.getElementById('editModeUsername').value = userToEdit.username;

      const usernameInput = document.getElementById('username');
      usernameInput.value = userToEdit.username;
      usernameInput.disabled = true;

      document.getElementById('role').value = userToEdit.role;
      document.getElementById('password').value = '';
      document.getElementById('password').placeholder = 'Leave blank to keep current password';
      document.getElementById('password').required = false;
      document.getElementById('passwordHelp').style.display = 'block';
      document.getElementById('userFormWrapper').style.display = 'block';
    }

    function hideUserForm() {
      document.getElementById('userFormWrapper').style.display = 'none';
      document.getElementById('userForm').reset();
      document.getElementById('username').disabled = false;
    }

    function handleUserFormSubmit(event) {
      event.preventDefault();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const role = document.getElementById('role').value;
      const editModeUsername = document.getElementById('editModeUsername').value;

      if (!username || !role) {
        alert('Username and role are required.');
        return;
      }

      if (editModeUsername) {
        const updatedData = { role };
        if (password) {
          updatedData.password = password;
        }
        const result = updateUser(editModeUsername, updatedData);
        if (result.success) {
          logEvent(currentAdminUser.username, 'USER_UPDATED', { updatedUser: editModeUsername, changes: updatedData });
          alert(`User '${editModeUsername}' updated successfully.`);
        } else {
          alert(`Error updating user: ${result.message}`);
        }
      } else {
        if (!password) {
          alert('Password is required for new users.');
          return;
        }
        const newUser = { username, password, role };
        const result = addUser(newUser);
        if (result.success) {
          logEvent(currentAdminUser.username, 'USER_CREATED', { createdUser: username, role: role });
          alert(`User '${username}' added successfully.`);
        } else {
          alert(`Error adding user: ${result.message}`);
        }
      }
      renderUserList();
      hideUserForm();
    }

    function handleUserListActions(event) {
      const target = event.target;
      const username = target.dataset.username;

      if (target.classList.contains('edit-btn')) {
        showEditForm(username);
      } else if (target.classList.contains('delete-btn')) {
        if (username === currentAdminUser.username) {
          alert('Error: Cannot delete the currently logged-in admin user.');
          return;
        }
        if (confirm(`Are you sure you want to delete user '${username}'? This action cannot be undone.`)) {
          const result = deleteUser(username);
          if (result.success) {
            logEvent(currentAdminUser.username, 'USER_DELETED', { deletedUser: username });
            alert(`User '${username}' deleted successfully.`);
            renderUserList();
          } else {
            alert(`Error deleting user: ${result.message}`);
          }
        }
      }
    }
  </script>
</body>
</html>
