<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0b152d">
  <title>Reports &amp; Logs</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <link rel="stylesheet" href="../styles/main.css">
</head>
<body>
  <main class="container">
    <header class="section">
      <h1>Reports &amp; Logs</h1>
      <p class="admin-welcome" id="adminWelcomeMessage"></p>
    </header>

    <section id="logEntriesContainer" class="section" aria-live="polite">
      <!-- Log entries injected here -->
    </section>

    <div class="action-buttons">
      <button class="download-btn" onclick="downloadLogs()">Download Logs</button>
      <a href="admin-dashboard.html" class="back-btn secondary">‚Üê Back to Dashboard</a>
    </div>
  </main>

  <script src="../scripts/data.js"></script>
  <script src="../scripts/app.js"></script>
  <script src="../scripts/theme.js" defer></script>
  <script>
    let currentAdminUser = null;

    document.addEventListener('DOMContentLoaded', function() {
      if (typeof initializeData === 'function') initializeData();

      currentAdminUser = typeof getCurrentUser === 'function' ? getCurrentUser() : null;

      if (!currentAdminUser || currentAdminUser.role !== 'admin') {
        alert('Access Denied. You must be an admin to view logs.');
        document.getElementById('logEntriesContainer').innerHTML = '<p class="error-message">Access Denied. Please log in as an admin.</p>';
        document.querySelector('.download-btn').disabled = true;
        return;
      }
      document.getElementById('adminWelcomeMessage').textContent = `Logged in as: Admin ${currentAdminUser.username}`;
      renderLogs();
    });

    function renderLogs() {
      const logEntriesContainer = document.getElementById('logEntriesContainer');
      logEntriesContainer.innerHTML = '';

      const logs = getLogs();
      if (!logs || logs.length === 0) {
        logEntriesContainer.innerHTML = '<p class="muted">No logs found.</p>';
        return;
      }

      logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      logs.forEach(log => {
        const logDiv = document.createElement('div');
        logDiv.className = 'log-entry';

        let detailsString = log.details;
        if (typeof log.details === 'object') {
          try {
            detailsString = JSON.stringify(log.details);
          } catch (e) {
            detailsString = 'Error stringifying details object.';
            console.error('Error stringifying log details:', e, log.details);
          }
        }

        logDiv.innerHTML = `
          <p><strong>Timestamp:</strong> ${new Date(log.timestamp).toLocaleString()}</p>
          <p><strong>User ID:</strong> ${log.userId || 'N/A'}</p>
          <p><strong>Action:</strong> ${log.action || 'N/A'}</p>
          <p><strong>Details:</strong> ${detailsString || 'N/A'}</p>
        `;
        logEntriesContainer.appendChild(logDiv);
      });
    }

    function downloadLogs() {
      const logs = getLogs();
      if (!logs || logs.length === 0) {
        alert('No logs to download.');
        return;
      }

      logs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

      let formattedLogString = 'Timestamp,User ID,Action,Details\n';

      logs.forEach(log => {
        let detailsString = log.details;
        if (typeof log.details === 'object') {
          try {
            detailsString = JSON.stringify(log.details).replace(/"/g, '""');
          } catch (e) {
            detailsString = 'Error stringifying details';
          }
        }
        const timestamp = `"${new Date(log.timestamp).toLocaleString()}"`;
        const userId = `"${log.userId || ''}"`;
        const action = `"${log.action || ''}"`;
        detailsString = `"${detailsString || ''}"`;

        formattedLogString += `${timestamp},${userId},${action},${detailsString}\n`;
      });

      const blob = new Blob([formattedLogString], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');

      if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        const date = new Date();
        const filename = `secure_walkways_logs_${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}_${String(date.getHours()).padStart(2,'0')}${String(date.getMinutes()).padStart(2,'0')}.csv`;
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }
    }
  </script>
</body>
</html>
